<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Taverna Server 2.4.1 Administration Interface</title>
<link id="admin" href="admin" />
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
<script type="text/javascript">
$(function() {
    var userinfo = {};
    var buttonlist = [
	"allowNew", "logFaults", "logWorkflows"];
    var readonlies = [
	"invokationCount", "lastExitCode", "runCount", "startupTime"];
    var entries = [
	"defaultLifetime", "executeWorkflowScript", "javaBinary",
	"registrationPollMillis", "registrationWaitSeconds", "registryHost",
	"registryPort", "runLimit", "runasPasswordFile", "serverForkerJar",
	"serverWorkerJar", "usageRecordDumpFile"];
    var doc = document.implementation.createDocument(null, null, null);
    var adminNS = "http://ns.taverna.org.uk/2010/xml/server/admin/";

    function where(tail) {
	return $("#admin")[0].href + "/" + tail;
    }

    // Wrappers round AJAX calls to simplify *most* of this stuff
    function getText(u, done) {
	$.ajax({type: "GET", url: u, async: true, cache: false,
	    accept: "text/plain", dataType: "text", success: done});
    }
    function getJSON(u, done) {
	$.ajax({type: "GET", url: u, async: true, cache: false,
	    dataType: "json", accept: "application/json", success: done});
    }
    function putText(u, val, done) {
	$.ajax({type: "PUT", url: u, async: false, cache: false, data: val,
	    contentType: "text/plain", dataType: "text", processData: false,
	    success: done, error: function(jqXHR, textStatus, errorThrown) {
		alert(errorThrown);
	    }});
    }
    function putXML(u, xml, done) {
	$.ajax({type: "PUT", url: u, async: false, cache: false,
	    contentType: "application/xml",
	    data: new XMLSerializer().serializeToString(xml),
	    success: done, error: function(jqXHR, textStatus, errorThrown) {
		alert(errorThrown);
	    }});
    }
    function postXML(u, xml, done) {
	$.ajax({type: "POST", url: u, async: false, cache: false,
	    contentType: "application/xml",
	    data: new XMLSerializer().serializeToString(xml),
	    success: done, error: function(jqXHR, textStatus, errorThrown) {
		alert(errorThrown);
	    }});
    }
    function deleteUrl(u, done) {
	$.ajax({type: "DELETE", url: u, async: true, cache: false,
	    success: done, error: function(jqXHR, textStatus, errorThrown) {
		alert(errorThrown);
	    }});
    }

    // How to update the read-only fields; will be called periodically
    function updateRO() {
	$.each(readonlies, function(idx,val) {
	    var widget = $("#" + val);
	    getText(where(val), function(data) {widget.html(data);});
	});
	getJSON(where("factoryProcessMapping"), function(data) {
	    var ary = data.stringList.string;
	    var tbl = $("#factoryProcessMapping");
	    tbl.html("<tr><th>User<th>ID</tr>");
	    if (ary != undefined)
		for (var i=0 ; i<ary.length-1 ; i+=2)
		    tbl.append("<tr><td>"+ary[i]+"<td>"+ary[i+1]+"</tr>");
	});
    }

    // How to update the table of users; called on demand
    function refreshUsers() {
	var usertable = $("#userList");
	getJSON(where("users"), function(data) {
	    $(".userrows").remove();
	    userinfo = {};
	    $.each(data.userList.user, function(idx, url) {
		usertable.append(
			"<tr id='usersep"+idx+"' class='userrows'>" +
			"<td colspan=6><hr></td></tr>" +
			"<tr id='userrow"+idx+"' class='userrows'>" +
			"<td><span id='username"+idx+"'></span></td>" +
			"<td><input id='userlocal"+idx+"' /></td>" +
			"<td><label for='useron"+idx+"'>Enabled</label>" +
			"<input type='checkbox' id='useron"+idx+"' /></td>" +
			"<td><label for='useradmin"+idx+"'>Admin</label>" +
			"<input type='checkbox' id='useradmin"+idx+"' /></td>" +
			"<td><button id='userpass"+idx+"'>Set Password</button></td>" +
			"<td><button id='userdel"+idx+"'>Delete</button></td>" +
			"</tr>");
		var i = idx;
		userinfo[i] = {url:url};
		getJSON(url, function(data) {
		    var model = userinfo[i].model = data.userDesc;
		    $("#username" + i).html(model.username);
		    $("#userlocal" + i).val(model.localUserId).change(function(){
			updateUser(i, "localUserId", $(this).val());
		    });
		    $("#useron" + i).button().attr("checked", model.enabled).button("refresh").click(function() {
			updateUser(i, "enabled",
				$(this).attr("checked") == "checked");
		    });
		    $("#useradmin" + i).button().attr("checked", model.admin).button("refresh").click(function() {
			updateUser(i, "admin",
				$(this).attr("checked") == "checked");
		    });
		    $("#userpass" + i).button({
			icons: {primary: "ui-icon-alert"}
		    }).click(function() {
			updatePasswordUser(i);
		    });
		    $("#userdel" + i).button({
			icons: {primary: "ui-icon-trash"},
			text: false
		    }).click(function() {
			deleteUser(i);
		    });
		});
		return true;
	    });
	});
    }

    // How to delete a user by index (with dialog)
    function deleteUser(idx) {
	$("#dialog-confirm").dialog({
	    modal: true,
	    autoOpen: false,
	    buttons: {
		"OK": function() {
		    $(this).dialog("close");
		    deleteUrl(userinfo[idx].url, function() {
			refreshUsers();
		    });
		},
		"Cancel": function() {
		    $(this).dialog("close");
		}
	    }
	});
	$("#dialog-confirm").dialog("open");
    }

    // How to update a user's password by index (with dialog)
    function updatePasswordUser(idx) {
	$("#change-password").val("");
	$("#dialog-password").dialog({
	    modal: true,
	    autoOpen: false,
	    buttons: {
		"OK": function() {
		    $(this).dialog("close");
		    var pass = 	$("#change-password").val();
		    $("#change-password").val("");
		    updateUser(idx, "password", pass);
		},
		"Cancel": function() {
		    $(this).dialog("close");
		    $("#change-password").val("");
		}
	    }
	});
	$("#dialog-password").dialog("open");
    }

    // Make an XML element structure
    // Derived from hack on Stack Overflow, but with extra tinkering
    function Node() {
	var node = doc.createElementNS(adminNS, arguments[0]), child;
	for (var i = 1; i < arguments.length; i++) {
	    child = arguments[i];
	    if (child == undefined)
		continue;
	    if (typeof child != 'object')
		child = doc.createTextNode(child.toString());
	    node.appendChild(child);
	}
	return node;
    }

    // How to set a specific field of a user record
    function updateUser(idx, field, value) {
	var model = userinfo[idx].model;
	var xml = Node("userDesc",
	    Node("username", model.username),
	    field=="password"
		? Node("password", value)
		: undefined,
	    field=="localUserId"
		? Node("localUserId", value)
		: model.localUserId == undefined
		    ? undefined
		    : Node("localUserId", model.localUserId),
	    Node("enabled", field=="enabled" ? value : model.enabled),
	    Node("admin", field=="admin" ? value : model.admin));
	putXML(userinfo[idx].url, xml, function() {refreshUsers();});
    }

    // Must be done in this order because the accordion is inside a tab
    $("#a-worker").accordion({
	collapsible: true,
	fillSpace: true, 
	autoHeight: false
    });
    $("#body").tabs({
	selected: 0
    });

    // Make the link to the list of usage records point correctly
    // Original plan called for browsable table, but that's too slow
    $("#ur").attr("href", where("usageRecords"));

    $.each(buttonlist, function(idx, val) {
	var widget = $("#" + val);
	var u = where(val);
	widget.button();
	getText(u, function(data) {
	    widget.attr('checked', (data+"") != "false");
	    widget.button("refresh");
	});
	widget.change(function() {
	    putText(u, widget.attr("checked") == "checked", function(data) {
		widget.attr('checked', (data+"") != "false");
		widget.button("refresh");
		return true;
	    });
	});
    });

    updateRO();
    setInterval(updateRO, 30000);

    $.each(entries, function(idx, val) {
	var widget = $("#" + val);
	var u = where(val);
	getText(u, function(data) {widget.val(data);});
	widget.change(function() {
	    putText(u, widget.val(), function(data) {
		widget.val(data);
		return true;
	    });
	})
    });

    refreshUsers();
    $("#newEnabled").button();
    $("#newAdmin").button({
	icons: {primary: "ui-icon-alert"}
    });
    $("#makeNewUser").button().click(function(){
	var sysid = $("#newSysID").val();
	var newuserinfo = {
	    admin: $("#newAdmin").attr("checked") == "checked",
	    enabled: $("#newEnabled").attr("checked") == "checked",
	    username: $("#newUsername").val(),
	    password: $("#newPassword").val()
	};
	// Blank out the password immediately!
	$("#newPassword").val("");
	if (sysid.length > 0) {
	    newuserinfo.localUserId = sysid;
	}
	if (newuserinfo.username =="" || newuserinfo.password == "") {
	    alert("Won't create user; need a username and a password!");
	    return;
	}
	var xml = newuserinfo = Node("userDesc",
	    Node("username", newuserinfo.username),
	    Node("password", newuserinfo.password),
	    newuserinfo.localUserId==undefined
		? undefined
		: Node("localUserId", newuserinfo.localUserId),
	    Node("enabled", newuserinfo.enabled),
	    Node("admin", newuserinfo.admin));
	postXML(where("users"), xml, function() {refreshUsers();});
    });
});
</script>
<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/themes/excite-bike/jquery-ui.css" rel="stylesheet" type="text/css" />

</head>
<body>
<img height="70" style="float:left"
src="http://dev.mygrid.org.uk/wiki/download/attachments/2786374/t2cogs.png?version=1&modificationDate=1238506904000">
<h1>Taverna Server 2.4.1 Administration Interface <i>(prototype)</i></h1>
<br clear="left"/>
<div id="body">
<ul>
  <li><a href="#t-global">Global Settings</a></li>
  <li><a href="#t-users">Users</a></li>
  <li><a href="#t-usage">Usage Records</a></li>
  <li><a href="#t-worker">Local Worker Configuration</a></li>
</ul>
  
<div id="t-global">
<label for="invokationCount">Invokation Count:</label>
<span id="invokationCount">0</span>
<br>
<label for="runCount">Run Count:</label>
<span id="runCount">0</span>
<br>
<label for="startupTime">Back-End Startup Time (seconds):</label>
<span id="startupTime">0</span>
<br>
<label for="lastExitCode">Back-End Last Exit Code:</label>
<span id="lastExitCode"></span>
<p>
<label for="allowNew">Allow New Runs</label>
<input type="checkbox" id="allowNew" />
<label for="logWorkflows">Log Executed Workflows</label>
<input type="checkbox" id="logWorkflows" />
<label for="logFaults">Log User Exceptions</label>
<input type="checkbox" id="logFaults" />
<p>
<label for="runLimit">Maximum Simultaneous Workflow Runs</label>
<input id="runLimit" size="3" />
<br>
<label for="defaultLifetime">Default Run Lifetime (seconds)</label>
<input id="defaultLifetime" size="7" />
</div><!-- t-global -->

<div id="t-users">
<table id="userList">
  <tr><th>Username<th>System Username</tr>
</table>
<h3>Add a user</h3>
<table border=1>
  <tr>
    <td><label for="newUsername">Username</label>
    <td><input size=12 id="newUsername" />
  </tr>
  <tr>
    <td><label for="newPassword">Password</label>
    <td><input size=12 id="newPassword" type="password"/>
  </tr>
  <tr>
    <td><label for="newSysID">System ID</label>
    <td><input size=12 id="newSysID" />
  </tr>
  <tr><td colspan=2>
    <label for="newEnabled">Enabled</label>
    <input type="checkbox" id="newEnabled" />
    <label for="newAdmin">Admin</label>
    <input type="checkbox" id="newAdmin" />
  </td></tr>
  <tr><td colspan=2>
    <button id="makeNewUser">Create a new user</button>
  </td></tr>
</table>
</div><!-- t-users -->

<div id="t-usage">
Download <a href="#" id="ur">usage records</a> (warning: may be slow!)
<p>
<label for="usageRecordDumpFile">Usage Record Dump File</label>
<input id="usageRecordDumpFile" size="50" />
</div><!-- t-usage -->

<div id="t-worker">
  <div id="a-worker">

    <h3><a href="#">Subprocess Implementation Control</a></h3>
    <div>
      <table>
	<tr>
	  <td> <label for="javaBinary">Java Executable (for subprocesses):</label> </td>
	  <td> <input id="javaBinary" size="80" /> </td>
	</tr>
	<tr>
	  <td> <label for="serverForkerJar">Subprocess Factory JAR:</label> </td>
	  <td> <input id="serverForkerJar" size="80" /> </td>
	</tr>
	<tr>
	  <td> <label for="runasPasswordFile">File with password for sudo:</label> </td>
	  <td> <input id="runasPasswordFile" size="80" /> </td>
	</tr>
	<tr>
	  <td> <label for="serverWorkerJar">User Filesystem Access JAR:</label> </td>
	  <td> <input id="serverWorkerJar" size="80" /> </td>
	</tr>
	<tr>
	  <td> <label for="executeWorkflowScript">Workflow Engine Executable:</label> </td>
	  <td> <input id="executeWorkflowScript" size="80" /> </td>
	</tr>
      </table>
    </div>

    <h3><a href="#">Worker Registration Control</a></h3>
    <div>
      <label for="registryHost">Registry Host</label>
      <input id="registryHost" size="20" />
      <label for="registryPort">Port</label>
      <input id="registryPort" size="5" />
      <br>
      <label for="registrationWaitSeconds">Time to wait for registration (seconds)</label>
      <input id="registrationWaitSeconds" size="5" />
      <br>
      <label for="registrationPollMillis">Time to wait between polling to
      detect registration (milliseconds)</label>
      <input id="registrationPollMillis" size="5" />
    </div>

    <h3><a href="#">System User/Factory ID Mapping</a></h3>
    <div>
      <table id="factoryProcessMapping" border="1">
      </table>
    </div>

  </div><!-- a-worker -->
</div><!-- t-worker -->

</div>

<hr>
<address>Donal Fellows / University of Manchester</address>

<!-- DIALOG BOXES -->
<div id="dialog-confirm" title="Delete user?" style="display: none">
  <p>
  <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
  This user will be permanently deleted from the system. Are you sure?
  </p>
</div>

<div id="dialog-password" title="Change password?" style="display: none">
  <p>
  <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
  This will permanently change the user's password. Make sure you wish
  to do this.
  </p>
  <p>
  <input id="change-password" type="password" size="12" />
  </p>
</div>

</body>
</html>
