<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<!-- 
 * Copyright (C) 2011 The University of Manchester
 * 
 * See the file "LICENSE.txt" for license terms.
-->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Taverna 2 Server: Deployment and Administration</title>
</head>
<body>
<div style="float: right; background: #eeeeee">
<ul>
	<li><a href="#tomcat">Deployment within Tomcat</a></li>
	<li><a href="#properties">Configuration Property List</a></li>
	<li><a href="#users">User Accounts</a></li>
	<li><a href="#impersonation">Configuration of Impersonation</a></li>
</ul>
</div>
<div class="head">
	<img
		src="http://www.taverna.org.uk/pages/wp-content/uploads/2010/07/taverna-server-logo.png"
		style="float: left" width="100" height="100" />
	<h1>Deployment and Administration of Taverna 2.3 Server</h1>
	<br clear="all">
	<hr>
</div>
<div class="section">
	<a name="tomcat"></a>
	<h2>Deployment within Tomcat</h2>
	<p>
		Deployment of web applications into Tomcat can be done through
		multiple mechanisms, notably through command line tools and through
		Tomcat's online administration interface. This document describes the
		latter mechanism. Note also that we currently only support the use of
		Taverna Server within a Unix environment (e.g., Linux, Mac OS X);
		there is no reason in principle why the code should not be adaptable
		to Microsoft Windows, but there is currently no impersonation module
		written to integrate Taverna Server with that operating platform.
	</p>
	<p>
		This assumes that you installing into Tomcat 6 running on top of Java
		6; this was tested with Tomcat 6.0.26 over the Sun JRE 1.6.0_14.
		Later patch version from the same major versions are also recommended
		(if available).
	</p>
	<p>
		To deploy Taverna Server within Tomcat, it is first <i>necessary</i>
		to install of the Taverna command line tool; we assume for the rest of
		this document that this is in
		<tt>/usr/taverna</tt>
		i.e., that that directory that contains the
		<tt>executeworkflow.sh</tt>
		script. With that basic prerequisite, installation is done by writing
		a context descriptor document. An example of that XML document is
		below:
	</p>
<div class="sample" style="background-color: #EEEEEE"><pre>
&lt;Context path="<font color="red">/taverna2</font>"&gt;
    <font color="#909090"><i>&lt;!-- Sample logging configuration. --&gt;</i></font>
    &lt;Valve className="org.apache.catalina.valves.AccessLogValve" /&gt;

    <font color="#909090"><i>&lt;!-- REQUIRED configuration parameter. --&gt;</i></font>
    &lt;Parameter name="executeWorkflowScript"
        value="<font color="red">/usr/taverna/executeworkflow.sh</font>" /&gt;

    <font color="#909090"><i>&lt;!-- For email-dispatched notifications. --&gt;</i></font>
    &lt;Parameter name="email.host" value="<font color="red">localhost</font>" /&gt;
&lt;/Context&gt;
</pre></div>
	<p>
		The context descriptor is typically in a file called
		<tt>context.xml</tt>
		and there is a sample context descriptor with this distribution, in
		the
		<tt>context.sample.xml</tt>
		file. There are a substantial number of properties that may be tuned
		during installation (see below) but the principal ones are the
		<tt>executeWorkflowScript</tt>
		parameter and the ones in relation to impersonation (see the
		discussion in <b>Configuration of Impersonation</b> for more
		information about the latter; not all configuration is necessarily of
		the webapp!)
	</p>
	<p>
		The actual deployment is done by giving the actual context location
		(i.e., the base URL of the webapp relative to the whole Tomcat
		container) as a separate field, together with URLs (it is useful to
		use
		<tt>file:</tt>
		URLs for this) to the context descriptor document and the distributed
		WAR file.
	</p>
</div>
<div class="section">
	<a name="properties"></a>
	<h2>Configuration Property List</h2>
	<p>
		This is a list of all the properties that are set by default in the
		Server (NB: the properites in <font color="red">red</font> are
		actually unset by default, but they are all understood). They may be
		overridden by the use of configuration parameters as described above;
		for example, to override the default local user name, the
		<tt>default.localusername</tt>
		configuration parameter would be set.
	</p>
<div class="sample" style="background-color: #EEEEEE"><pre>
<font color="#909090"><i># Script in Taverna installation to run to actually execute workflows</i></font>
executeWorkflowScript:      <font color="red">/usr/taverna/executeworkflow.sh</font>

<font color="#909090"><i># User name to use by default for impersonation if nothing else specified</i></font>
default.localusername:      taverna

<font color="#909090"><i># How to pick a user name out of a global identity</i></font>
localusernameregexp:	^TAVERNAUSER=(.*)$
<font color="#909090"><i># Whether to log incoming workflows; noisy if enabled</i></font>
default.logworkflows:	false
<font color="#909090"><i># Whether to log outgoing exceptions; noisy if enabled</i></font>
default.logexceptions:	false
<font color="#909090"><i># Whether to allow workflows to be submitted; adjustable via admin interfaces</i></font>
default.permitsubmit:	true
<font color="#909090"><i># How long a workflow run should live by default, in seconds</i></font>
default.lifetime:		1440
<font color="#909090"><i># Maximum number of simultaneous workflow runs, in any state</i></font>
default.runlimit:		100

<font color="#909090"><i># Location of impersonation credentials</i></font>
secureForkPasswordFile:     <font color="red">/usr/local/tomcat6.0/conf/sudopass.txt</font>

<font color="#909090"><i># URI to server's REST interface</i></font>
taverna.preferredUserUri:   <font color="red">https://some.host:8443/tavernaserver/rest/</font>

<font color="#909090"><i># Delays used in the task executor, both in milliseconds</i></font> 
purge.interval:             30000
finish.interval:            10000

<font color="#909090"><i># Thread pool sizing</i></font>
pool.size:                  2

<font color="#909090"><i># Stylesheet to apply to generated XML - EXPERIMENTAL!</i></font>
xml.stylesheet.url:         http://www.linkwerk.com/pub/xml/xml2html/xml2html.xslt

<font color="#909090"><i>### Usage Record handling</i></font>
usage.logFile:              none
usage.disableDB:            no

<font color="#909090"><i>### General configuration of messaging</i></font>
<font color="#909090"><i># cooldown in seconds</i></font>
message.cooldown:           300
message.termination.subject:        Taverna workflow run finished
message.termination.body:   Your job with ID={0} has finished with exit code {1,number,integer}.

<font color="#909090"><i>### Email-specific options</i></font>
email.from:                 taverna.server@localhost
email.type:                 text/plain
email.host:                 <font color="red">localhost</font>

<font color="#909090"><i>### Jabber-specific options</i></font>
xmpp.server:                <font color="red">xmpp://some.host:5222</font>
xmpp.resource:              TavernaServer
xmpp.user:                  <font color="red">taverna</font>
xmpp.password:              <font color="red">*******</font>

<font color="#909090"><i>### Atom/RSS feed; lifespan in days, cleaninterval in milliseconds</i></font>
atom.language:              en
atom.lifespan:              7
atom.cleaninterval:         3600000

<font color="#909090"><i>### SMS-specific options</i></font>
sms.service:                <font color="red">https://www.intellisoftware.co.uk/smsgateway/sendmsg.aspx</font>
sms.userfield:              username
sms.passfield:              password
sms.destfield:              to
sms.msgfield:               text
sms.user:                   <font color="red">taverna</font>
sms.pass:                   <font color="red">*******</font>

<font color="#909090"><i>### Twitter-specific options</i></font>
twitter.oauth.accessToken:  <font color="red">*******</font>
twitter.oauth.accessTokenSecret:    <font color="red">*******</font>
</pre></div>
</div>
<div class="section">
	<a name="users"></a>
	<h2>User Accounts</h2>
		<p>
			Once you have deployed the server, you can use either JMX or the
			<tt>/admin</tt>
			interface to create and manage accounts. Only accounts with
			administrative permission can do such management. The initial set of
			users is loaded into the database from the
			<tt>WEB-INF/security/users.properties</tt>
			file in the deployment package; see the comments in that file for a
			more complete description of its contents; the file is only used if
			the user database is empty.
		</p>
		<p>
			By default, two enabled users are created. One is a normal user
			(<tt>taverna</tt>, with password <tt>taverna</tt>) and the other is
			an administrative user (<tt>admin</tt>, password <tt>admin</tt>).
			<i>These defaults should be changed after installation as they are
			not considered secure by default.</i> More information about the
			mapping process is in the
			<a href="security.html">security summary document</a>. 
		</p>
	</div>
<div class="section">
	<a name="impersonation"></a>
	<h2>Configuration of Impersonation</h2>
	<p>
		If it is desired to separate each user of Taverna Server from the
		others, it is necessary to configure impersonation of users. That is,
		the user account that is running the servlet container (Tomcat, etc.)
		must have permission somehow to execute code as other users. (If this
		is not desired, the service should be configured to use the simpler
		non-impersonating worker factory &mdash; see the
		<tt>backEndFactory</tt>
		property above &mdash; or the fallback user identity to use for
		impersonation should be set in the
		<tt>default.localusername</tt>
		to the same identity as the user account used for running the server.)
	</p>
	<p>
		This is done by either instructing the service what password is to be
		used with
		<tt>sudo</tt>
		(typically the password for the account that is invoking the
		<tt>sudo</tt>
		command) or by configuring
		<tt>sudo</tt>
		itself so that the service account is more highly authorized than a
		normal account. The first style of impersonation, which requires that
		the service account have a password at all, is enabled by creating a
		file (in a suitably secured directory) that contains the password as
		its only content, and telling Taverna Server about it during
		deployment by giving the full pathname of the file in the
		<tt>secureForkPasswordFile</tt>
		deployment parameter. The second style of impersonation is done by
		leaving that parameter unset and instead adding some extra
		configuration to the system's
		<tt>/etc/sudoers</tt>
		file, as seen below (typically set with the
		<tt>visudo</tt>
		command). Note that conventionally the three parts of the
		configuration are in separate sections of the file, and that care
		should be taken during configuration as mistakes can result in a
		system that is broken. In the example below, we assume that the
		servlet container is running as the Unix user
		<tt>tavserv</tt>
		and that local user accounts that may be targets for impersonation are
		all members of the
		<tt>taverna</tt>
		Unix group.
	</p>
<div class="sample" style="background-color: #EEEEEE"><pre>
<font color="#909090"><i># Flags for the tavserv user (keep things quiet)</i></font>
Defaults:tavserv   !lecture, timestamp_timeout=0, passwd_tries=1

<font color="#909090"><i># Who can we impersonate? Manage via Unix group called 'taverna'</i></font>
Runas_Alias        TAV = %taverna

<font color="#909090"><i># The actual permission to impersonate, with permission to run anything</i></font>
tavserv            ALL=(TAV) NOPASSWD: ALL
</pre></div>
	<p>
		Care should be taken as without a password specified and without
		permission to execute as another user, an attempt to create a workflow
		run will
		<i>hang</i> instead of failing.
	</p>
</div>
<div class="footer">
	<p>
		<small>Copyright &copy; 2011. The University of Manchester.</small>
	</p>
</div>
</body>
</html>